<!DOCTYPE html>
<html>
<head>
    <title>Collective Coin - 3D Coin Flip Game</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/near-api-js@0.44.2/dist/near-api-js.min.js"></script>
    <style>
        body, html { margin: 0; padding: 0; font-family: 'Roboto', Arial, sans-serif; background-color: #1a1a2e; color: #fff; display: flex; align-items: center; justify-content: center; min-height: 100vh; }
        #gameContainer { width: 90%; max-width: 800px; height: 60vh; max-height: 500px; border-radius: 10px; overflow: hidden; box-shadow: 0 0 20px rgba(255, 255, 255, 0.1); }
        #gameCanvas { width: 100%; height: 100%; }
        #controls, #loading { margin-top: 20px; display: flex; flex-direction: column; align-items: center; }
        button { margin: 10px; padding: 12px 24px; font-size: 16px; cursor: pointer; background-color: #4a4e69; color: #fff; border: none; border-radius: 5px; transition: 0.3s; }
        button:hover { background-color: #22223b; transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        #gameMode { display: flex; justify-content: center; }
        .mode-btn { background-color: #3a3a5a; color: #fff; padding: 10px 20px; margin: 0 10px; cursor: pointer; border-radius: 5px; transition: 0.3s; }
        .mode-btn.active { background-color: #6a6a8a; }
        #betAmount { margin-top: 10px; padding: 8px; font-size: 16px; width: 100px; text-align: center; }
        .hidden { display: none; }
        .spinner { border: 5px solid #f3f3f3; border-top: 5px solid #3498db; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <h1>Collective Coin Flip</h1>
    <div id="gameContainer"><canvas id="gameCanvas"></canvas></div>
    <div id="controls">
        <div id="gameMode">
            <button class="mode-btn active" id="freePlayBtn">Free Play</button>
            <button class="mode-btn" id="realMoneyBtn">Real Money</button>
        </div>
        <input type="number" id="betAmount" placeholder="Bet amount" class="hidden" min="0.1" step="0.1">
        <button id="headsBtn">Guess Heads</button>
        <button id="tailsBtn">Guess Tails</button>
        <button id="connectWalletBtn">Connect HERE Wallet</button>
    </div>
    <div id="result"></div>
    <div id="balance"></div>
    <div id="loading" class="hidden"><div class="spinner"></div></div>

    <script>
        const scene = new THREE.Scene(), camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000), renderer = new THREE.WebGLRenderer({ canvas: document.getElementById('gameCanvas'), antialias: true });
        renderer.setSize(window.innerWidth * 0.9, window.innerHeight * 0.6);
        scene.add(new THREE.AmbientLight(0xffffff, 0.5));
        const directionalLight = new THREE.DirectionalLight(0xffffff, 0.5); directionalLight.position.set(5, 5, 5); scene.add(directionalLight);

        const coinGeometry = new THREE.CylinderGeometry(2, 2, 0.2, 64), coinMaterialHeads = new THREE.MeshPhongMaterial({ color: 0xffA500, metalness: 0.7, roughness: 0.3 }), coinMaterialTails = new THREE.MeshPhongMaterial({ color: 0x4B0082, metalness: 0.7, roughness: 0.3 });
        const coin = new THREE.Mesh(coinGeometry, [coinMaterialHeads, coinMaterialTails, new THREE.MeshPhongMaterial({ color: 0xc0c0c0, metalness: 0.8, roughness: 0.2 })]); scene.add(coin); camera.position.z = 10;

        new THREE.FontLoader().load('https://threejs.org/examples/fonts/helvetiker_regular.typeface.json', function (font) {
            const textGeometry = new THREE.TextGeometry('Collective Coin', { font: font, size: 0.3, height: 0.05, bevelEnabled: true, bevelThickness: 0.02, bevelSize: 0.01, bevelSegments: 5 }), textMaterialHeads = new THREE.MeshPhongMaterial({ color: 0x4B0082 }), textMaterialTails = new THREE.MeshPhongMaterial({ color: 0xffA500 });
            const textMeshHeads = new THREE.Mesh(textGeometry, textMaterialHeads), textMeshTails = new THREE.Mesh(textGeometry, textMaterialTails);
            textMeshHeads.position.set(-1.5, 0, 0.11); textMeshTails.position.set(-1.5, 0, -0.11); textMeshTails.rotation.x = Math.PI; coin.add(textMeshHeads); coin.add(textMeshTails);
        });

        function animateCoinFlip() {
            let rotationSpeed = Math.random() * 0.3 + 0.2, rotations = 0, totalRotations = Math.floor(Math.random() * 10) + 10;
            (function animate() { if (rotations < totalRotations) { coin.rotation.x += rotationSpeed; rotations += rotationSpeed / (2 * Math.PI); requestAnimationFrame(animate); } else { onFlipComplete(Math.random() < 0.5 ? 'heads' : 'tails'); } renderer.render(scene, camera); })();
        }

        const nearConfig = { networkId: 'mainnet', nodeUrl: 'https://rpc.mainnet.near.org', walletUrl: 'https://wallet.near.org', helperUrl: 'https://helper.mainnet.near.org', explorerUrl: 'https://explorer.mainnet.near.org' };
        let wallet, accountId;
        
        async function initNEAR() { const near = await nearApi.connect(nearConfig); wallet = new nearApi.WalletConnection(near); if (wallet.isSignedIn()) { accountId = wallet.getAccountId(); document.getElementById('connectWalletBtn').textContent = 'Disconnect Wallet'; updateBalance(); } }
        async function connectWallet() { wallet.isSignedIn() ? (wallet.signOut(), location.reload()) : wallet.requestSignIn({ contractId: 'collectivecoin.near', methodNames: ['ft_transfer'] }); }
        async function updateBalance() { if (accountId) { const balance = await wallet.account().getAccountBalance(); document.getElementById('balance').textContent = `Balance: ${parseFloat(balance.available) / 1e24} NEAR`; } }

        async function transferNEAR(amount, recipient) {
            const nearAmount = nearApi.utils.format.parseNearAmount(amount.toString());
            try { showLoading(); await wallet.account().functionCall({ contractId: 'collectivecoin.near', methodName: 'ft_transfer', args: { receiver_id: recipient, amount: nearAmount }, attachedDeposit: nearApi.utils.format.parseNearAmount('0.000000000000000000000001') }); updateBalance(); hideLoading(); } catch (error) { console.error('Transfer failed:', error); document.getElementById('result').textContent = 'Transfer failed. Please try again.'; hideLoading(); }
        }

        let userGuess, isRealMoney = false;
        function onFlipComplete(result) {
            const resultElement = document.getElementById('result'), betAmount = parseFloat(document.getElementById('betAmount').value) || 0;
            result === userGuess ? (isRealMoney ? resultElement.textContent = `You won ${betAmount.toFixed(2)} NEAR!` : resultElement.textContent = 'You won! (Free Play)', isRealMoney && wallet.isSignedIn() && transferNEAR(betAmount, accountId)) : (isRealMoney ? resultElement.textContent = `You lost ${betAmount.toFixed(
